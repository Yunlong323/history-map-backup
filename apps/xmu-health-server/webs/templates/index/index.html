<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>厦大通行码</title>

    
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">


    <link href="{{ buildStaticUrl('/css/style.css') }}" rel="stylesheet">




    <style type="text/css">
        #allmap {position:absolute;left:0px;width: 100%;height: 100%}

        .modal-backdrop {
            opacity: 0.8 !important;
            filter: alpha(opacity=0.8) !important;
        }

        /*取消百度地图logo*/
        .anchorBL{  
               display:none;
        } 
    </style>
</head>



<body>
<div id="wrapper">
    <nav class="navbar-default navbar-static-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav metismenu" id="side-menu">
                <li class="nav-header">
                    <div class="profile-element text-center">
                        <!-- <img alt="image" class="img-circle" src="{{ buildStaticUrl('/images/common/logo.png') }}"/> -->
                        <img alt="image" class="img-circle" src="https://passport.xmu.edu.cn/static/images/common/logo.png"/>
                    </div>
                </li>
                <li class="index">
                    <a href="{{ buildUrl('/') }}"><i class="fa fa-bar-chart fa-lg"></i> <span
                            class="nav-label">流量统计</span></a>
                </li>
                <li class="venue">
                    <a href="{{ buildUrl('/venue/index') }}"><i class="fa fa-home fa-lg"></i> <span
                            class="nav-label">场所管理</span></a>
                </li>

                <li class="user">
                    <a href="{{ buildUrl('/user/student') }}"><i class="fa fa-group fa-lg"></i> <span
                            class="nav-label">用户管理</span></a>
                </li>

                <li class="track">
                    <a href="{{ buildUrl('/track/index') }}"><i class="fa fa-search fa-lg"></i> <span
                            class="nav-label">轨迹查询</span></a>
                </li>

                <li class="trace">
                    <a href="{{ buildUrl('/trace/index') }}"><i class="fa fa-recycle fa-lg"></i> <span
                            class="nav-label">溯源管理</span></a>
                </li>

                    <li class="business">
                        <a href="{{ buildUrl('/business/index') }}"><i class="fa fa-line-chart fa-lg"></i> <span
                                class="nav-label">运营统计</span></a>
                    </li>

            </ul>
        </div>
    </nav>

    <div id="page-wrapper" class="gray-bg" style="background-color: #ffffff;">
        <!-- mapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmap -->
        <!-- 按钮触发模态框 -->
        <button class="btn btn-primary btn-lg hidden" data-toggle="modal" data-target="#myModal" id="echartstest">
        </button>
        <!-- 模态框（Modal） -->
        <div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" ><!-- background: transparent background-color:rgb(0,0,0);-->
                <div class="modal-content" style="width:1000px;background: transparent">
                    <div class="modal-body" style="width:1000px;">
                        <div id="main2" style="width:1000px;height:700px;">

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
           <div id="allmap"></div>
        </div>
        <!-- mapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmapmap -->
    </div>
</div>


<div class="hidden hidden_layout_wrap">
    <input name="domain" value="{{ config.APP.domain }}">
</div>



<script src="https://cdn.bootcdn.net/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.7.0/echarts-en.common.min.js"></script>


<script src="{{ buildStaticUrl('/plugins/layer/layer.js') }}"></script>
<script src="{{ buildStaticUrl('/js/common.js') }}"></script>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=D7f130ce4be999b80a56cfd12ab06a7a"></script>

</body>
</html>



<script type="text/javascript">

        var map = new BMap.Map("allmap");    // 创建Map实例
        map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
        map.centerAndZoom(new BMap.Point(118.115071,24.44031),15);  // 初始化地图,设置中心点坐标和地图级别
        map.setMapStyle({style:'midnight'})

        //获取所有场所
        $.ajax({
                url: common_ops.buildUrl("/index/getAllPOI"),
                type: "GET",
                dataType: "json",
                success: function (res) {
                    //console.log(res.code)
                    if (res.code == 200) {
                        // console.log(res.data)
                        var points = res.data
                        addMarker(points);
                    }
                },
                error: function (msg) {
                    console.log("错误"+msg)
                },

        })

        function addMarker(points) {
            //循环建立标注点
            for(var i=0; i<points.length; i++) {
                // console.log(points[i].name+"-"+points[i].id+"-"+points[i].lon+"-"+points[i].lat)
                var point = new BMap.Point(points[i].lon, points[i].lat); //将标注点转化成地图上的点
                var myIcon="";
                myIcon = new BMap.Icon("{{ buildStaticUrl('/images/common/map_icon.png') }}", new BMap.Size(40,45));
                
                var marker = new BMap.Marker(point,{icon:myIcon}); //将点转化成标注点
                map.addOverlay(marker);  //将标注点添加到地图上
                //添加监听事件
                (function() {
                    var thePoint = points[i];
                    marker.addEventListener("click",
                        function() {
                        showInfo(this,thePoint);
                    });
                 })();  
            }
        };

        var myChart2 = echarts.init(document.getElementById('main2'));//main2
        function showInfo(thisMarker,point) {

            $('.btn-lg').click();

            myChart2.setOption(
            {
                title: {
                    text: point.name+' 流量统计',
                    x:'center',
                    textStyle: {
                        fontWeight: 'normal',
                        fontSize: 16,
                        color: '#F1F1F3'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        lineStyle: {
                            color: '#57617B'
                        }
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: [{
                    type: 'category',
                    boundaryGap: false,
                    axisLine: {
                        lineStyle: {
                            color: '#fff'
                        }
                    },
                    data: []
                }],
                yAxis: [{
                    type: 'value',
                    name: '人次',
                    axisTick: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#fff'
                        }
                    },
                    axisLabel: {
                        margin: 10,
                        textStyle: {
                            fontSize: 14
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#57617B'
                        }
                    }
                }],
                series: [{
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 5,
                    showSymbol: false,
                    lineStyle: {
                        normal: {
                            width: 1
                        }
                    },
                    areaStyle: {
                        normal: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                offset: 0,
                                color: 'rgba(219, 50, 51, 0.3)'
                            }, {
                                offset: 0.8,
                                color: 'rgba(219, 50, 51, 0)'
                            }], false),
                            shadowColor: 'rgba(0, 0, 0, 0.1)',
                            shadowBlur: 10
                        }
                    },
                    itemStyle: {
                        normal: {
                            color: 'rgb(219,50,51)',
                            borderColor: 'rgba(219,50,51,0.2)',
                            borderWidth: 12
                        }
                    },
                    data: []
                }, ]
            });
            myChart2.showLoading();


            var names=[];    //类别数组（实际用来盛放X轴坐标值）
            var nums=[];    //销量数组（实际用来盛放Y坐标值）
        
            $.ajax({
                url: common_ops.buildUrl("/venue/getVenueStatistics"),
                type: "POST",
                data : {"id":point.id},
                dataType: "json",
                
                success : function(result) {
                    myChart2.hideLoading();    //隐藏加载动画
                    //请求成功时执行该函数内容，result即为服务器返回的json对象
                    if (result.data) {
                        for(var i=0;i<result.data.length;i++){
                            names.push(result.data[i].day);
                        }
                        for(var i=0;i<result.data.length;i++){
                            nums.push(result.data[i].count);
                        }
                        myChart2.setOption({        //加载数据图表
                            xAxis: {
                                data: names
                            },
                            series: [{
                                data: nums
                            }]
                        });
                    }
                },
                error : function(errorMsg) {
                    //请求失败时执行该函数
                    alert("图表请求数据失败!");
                    myChart2.hideLoading();
                }
            });
        }

</script>